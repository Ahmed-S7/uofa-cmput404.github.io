<!DOCTYPE html>
<html lang="en">
<head>
          <title>CMPUT 404 - HTTP Lab2</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Web Applications and Architecture" />

  <link rel="icon" href="../theme/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="../theme/style.css" />
  <link rel="stylesheet" type="text/css" href="../theme/404.css" />




    <meta name="tags" content="socket" />
    <meta name="tags" content="http" />
    <meta name="tags" content="socketserver" />

</head>

<body>
        <header>
              <hgroup><h1><a href="../">CMPUT 404</a></h1><p>Web Applications and Architecture</p></hgroup>
        <nav><ul>
            <li><a href="/general/outline.html">Outline</a></li>
            <li><a href="/#eclass">eClass & Grades</a></li>
            <li><a href="/#schedule">Schedule</a></li>
            <li><a href="/general/labs.html">Labs</a></li>
            <li><a href="/general/project.html">Project</a></li>
            <li><a href="/general/individual.html">Individual</a></li>
            <li><a href="/general/resources.html">Resources</a></li>
            <li><a href="/general/help.html#discussion-forum">Discussion Forum</a></li>
            <li><a href="/#news-notices">News & Notices</a></li>
            <li><a href="/#lecture-zoom">Lecture Zoom</a></li>
            <li><a href="/general/slides.html">Slides</a></li>
            <li><a href="/general/help.html">Help</a></li>
        </ul></nav>
        </header>
        <main>
<article>
  <header>
    <h2>
      <a href="../labsignments/http2.html" rel="bookmark"
         title="Permalink to HTTP Lab2">HTTP Lab2</a></h2>
 
  </header>
  <hr>
<div class="toc">
<ul>
<li><a href="#task1">Task1</a></li>
<li><a href="#getting-started">Getting Started</a><ul>
<li><a href="#import-the-python-socket-module">Import the python socket module</a></li>
<li><a href="#create-a-context-manager">Create a context manager</a></li>
<li><a href="#connect-to-a-remote-socket-at-specified-address">Connect to a remote socket at specified address</a></li>
<li><a href="#prepare-your-post-request">Prepare your post request</a></li>
<li><a href="#pass-your-request-byte-as-a-parameter-to-socketsendall-function">Pass your request byte as a parameter to socket.sendall function</a></li>
<li><a href="#process-and-receive-response">Process and receive response</a></li>
</ul>
</li>
<li><a href="#task-2">Task 2</a></li>
<li><a href="#getting-started_1">Getting Started</a><ul>
<li><a href="#import-the-libraries-needed-socketserver-and-pathlib">Import the libraries needed (socketserver and pathlib)</a></li>
<li><a href="#create-a-custom-server-class-to-inherit-from-the-tcpserver-class">Create a custom server class to inherit from the TCPServer class</a></li>
<li><a href="#create-the-custom-httphandler-class">Create the custom HttpHandler class</a></li>
<li><a href="#implement-the-handle-method">Implement the handle method</a><ul>
<li><a href="#receive-and-decode-request">Receive and decode request</a></li>
<li><a href="#extract-the-method-and-path-from-the-request-line">Extract the method and path from the request line</a></li>
<li><a href="#extract-the-headers-and-store-in-a-dictionary">Extract the headers and store in a dictionary</a></li>
<li><a href="#decide-the-action-to-take-based-on-the-http-method-type">Decide the action to take based on the Http method type</a></li>
</ul>
</li>
<li><a href="#start-the-server">Start the server</a></li>
</ul>
</li>
<li><a href="#task-3">Task 3</a></li>
<li><a href="#getting-started_2">Getting Started</a></li>
<li><a href="#http-clientserver-communication-diagram">HTTP Client/Server Communication Diagram</a></li>
</ul>
</div>
<h3 id="task1">Task1</h3>
<p>Your task is to implement a basic HTTP 1.1 client</p>
<h3 id="getting-started">Getting Started</h3>
<p>Building a basic client involves a series of steps as listed below</p>
<ul>
<li>Import the python socket module</li>
<li>Create a context manager</li>
<li>Connect to a remote socket at specified address</li>
<li>Prepare your post request</li>
<li>Pass your request byte as a parameter to socket.sendall function</li>
<li>Process and receive response</li>
</ul>
<h4 id="import-the-python-socket-module">Import the python socket module</h4>
<p>Here is a simple code snippet in Python:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span>
</code></pre></div>

<h4 id="create-a-context-manager">Create a context manager</h4>
<p>Create a context manager to ensure you close the socket once the block of code is executed
Utilize the context manager on the socket module to create a new socket object, This object has an overloaded constructor but we would utilize the two arguments constructor and pass the address family and the socket type. (i.e socket.AF_INET and socket.SOCK_STREAM)</p>
<ol>
<li>socket.AF_INET : represents the address type (for IPv4)</li>
<li>socket.SOCK_STREAM : represents the socket type (TCP socket)</li>
</ol>
<h4 id="connect-to-a-remote-socket-at-specified-address">Connect to a remote socket at specified address</h4>
<p>Connect to a remote socket at specified address. This uses the socket.connect(address) method to connect with the host address. The address is a tuple that holds the host or ip address and the port number of the server</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
   <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">))</span>
   <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connected to server at host </span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2"> and port </span><span class="si">{</span><span class="n">PORT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="prepare-your-post-request">Prepare your post request</h4>
<p>This would be formatted to include the HTTP method,  protocol, Host address, Content-Type and Content length and finally the data</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Prepare the HTTP POST request</span>
   <span class="n">request</span> <span class="o">=</span> <span class="p">(</span>
           <span class="s2">&quot;POST / HTTP/1.1</span><span class="se">\r\n</span><span class="s2">&quot;</span>
           <span class="sa">f</span><span class="s2">&quot;Host: </span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">PORT</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
           <span class="s2">&quot;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s2">&quot;</span>
           <span class="sa">f</span><span class="s2">&quot;Content-Length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
           <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
           <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
       <span class="p">)</span>
</code></pre></div>

<h4 id="pass-your-request-byte-as-a-parameter-to-socketsendall-function">Pass your request byte as a parameter to socket.sendall function</h4>
<p>Call the sendall function that accepts raw bytes to send the request to the server. Remember data is transmitted as bytes over the internet  and not strings. To convert the request string message to a byte, you encode the request using the utf-8 encoding.</p>
<div class="highlight"><pre><span></span><code><span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
</code></pre></div>

<h4 id="process-and-receive-response">Process and receive response</h4>
<p>We would utilize the recv method in socket class to receive response from the server. We need to create a bytes variable to accept responses. The recv() method takes the buffer size as an argument to capture the maximum amount of bytes to be received by the client. We set it 1024 for our case</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Receive the response</span>
   <span class="n">response</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
   <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
       <span class="n">part</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span>
           <span class="k">break</span>
       <span class="n">response</span> <span class="o">+=</span> <span class="n">part</span>
</code></pre></div>

<h3 id="task-2">Task 2</h3>
<p>Your task is to implement the server to talk to a normal client</p>
<h3 id="getting-started_1">Getting Started</h3>
<p>Getting your server to talk to a client involves the following steps</p>
<ul>
<li>Import the libraries needed (socketserver and pathlib)</li>
<li>Create a custom server class to inherit from the TCPServer class</li>
<li>Create the custom HttpHandler class</li>
<li>
<p>Implement the handle method</p>
<ul>
<li>Receive and decode request</li>
<li>Extract the method and path from the request line</li>
<li>Extract the headers and store in a dictionary</li>
<li>Decide the action to take based on the Http method type</li>
</ul>
</li>
<li>
<p>Start the server </p>
</li>
</ul>
<h4 id="import-the-libraries-needed-socketserver-and-pathlib">Import the libraries needed (socketserver and pathlib)</h4>
<p>The socketserver provides simplicity for creating network servers in python. The pathlib module is useful for managing filesystem path</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socketserver</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
</code></pre></div>

<h4 id="create-a-custom-server-class-to-inherit-from-the-tcpserver-class">Create a custom server class to inherit from the TCPServer class</h4>
<p>Create a custom server class and make it inherit from the socketserver.TCPServer class. This is the first step in setting up a server, There are four basic servers available within the socketserver module namely TCPServer, UDPServer,UnixStreamServer and UnixDatagramServer</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LabHttpTcpServer</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
   <span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>

<h4 id="create-the-custom-httphandler-class">Create the custom HttpHandler class</h4>
<p>Create the custom HttpHandler class by inheriting the socketserver.StreamRequestHandler to handle incoming requests. We utilized the socketserver.StreamRequestHandler class, a subclass of socketserver.BaseRequestHandler  because it provides implementation for rfile and wfile.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LabHttpTCPHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">StreamRequestHandler</span><span class="p">)</span>
</code></pre></div>

<h4 id="implement-the-handle-method">Implement the handle method</h4>
<p>This would involve some substeps</p>
<h5 id="receive-and-decode-request">Receive and decode request</h5>
<p>The rfile would be utilized to receive and decode the request sent from the client. Simply call the readline() method which calls the recv() method multiple times until a new character line is reached</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Receive and decode the request</span>
       <span class="n">request_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</code></pre></div>

<h5 id="extract-the-method-and-path-from-the-request-line">Extract the method and path from the request line</h5>
<p>The split method is used to divide the request into three different parts because the 2 ensure split is done only twice. The first line in a request_line always contains the HTTP METHOD  PATH and HTTP_Version.
For example GET  /index.html  HTTP/1.1 would be split into</p>
<div class="highlight"><pre><span></span><code>GET
/index.html
HTTP/1.1
</code></pre></div>

<p>The underscore is a convention used for values that would be ignored in our case the HTTP version</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Extract the method and path from the request</span>
       <span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<h5 id="extract-the-headers-and-store-in-a-dictionary">Extract the headers and store in a dictionary</h5>
<p>We created a custom method to handle this. We split the line using the colon delimiter to ensure the split is done on the content type</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">parse_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
       <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
           <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
               <span class="k">break</span>
           <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
           <span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
       <span class="k">return</span> <span class="n">headers</span>
</code></pre></div>

<h5 id="decide-the-action-to-take-based-on-the-http-method-type">Decide the action to take based on the Http method type</h5>
<p>All other method other than GET and POST are met with a 405 error</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">serve_static_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
       <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
           <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
           <span class="n">post_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


           <span class="bp">self</span><span class="o">.</span><span class="n">serve_post_response</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="s2">&quot;Method Not Allowed&quot;</span><span class="p">)</span>
</code></pre></div>

<h4 id="start-the-server">Start the server</h4>
<p>Start the server by calling the serve_forever method and pass the HOST, PORT</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   <span class="k">with</span> <span class="n">LabHttpTcpServer</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span><span class="n">PORT</span><span class="p">),</span><span class="n">LabHttpTCPHandler</span><span class="p">)</span> <span class="k">as</span> <span class="n">server</span><span class="p">:</span>
       <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;server is starting&quot;</span><span class="p">)</span>
       <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running&quot;</span><span class="p">)</span>
       <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span> 
</code></pre></div>

<h3 id="task-3">Task 3</h3>
<p>Your task is to serve multiple IP address from a single domain</p>
<h3 id="getting-started_2">Getting Started</h3>
<p>Implementation for serving multiple IP addresses from a single domain. Get the host header to determine the domain and apply this to the path</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Get the Host header to determine the domain</span>
       <span class="n">host</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Host&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>


       <span class="c1"># Base directory to serve files from</span>
       <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;www/</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
       <span class="c1"># Parse and sanitize the path</span>
       <span class="n">sanitized_path</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
</code></pre></div>

<h3 id="http-clientserver-communication-diagram">HTTP Client/Server Communication Diagram</h3>
<p><img alt="HTTP Client Server Communication" src="/Users/samueliwuchukwu/Documents/cmput404/code/uofa-cmput404.github.io/content/labsignments/images/http_diagram.png"></p>
  <footer>
    <p>Published: <time datetime="2024-07-17T00:00:00-06:00">
      Wed, 17 Jul 2024 at 00:00 MDT
    </time></p>
    <address>
      By           <a href="../author/samuel-iwuchukwu.html">Samuel Iwuchukwu</a>
          <a href="../author/hazel-victoria-campbell.html">Hazel Victoria Campbell</a>
    </address>
    <p>
        Category: <a href="../category/labsignments.html">labsignments</a>
    </p>
    <p>
        Tags:
            <a href="../tag/socket.html">socket</a>
            <a href="../tag/http.html">http</a>
            <a href="../tag/socketserver.html">socketserver</a>
    </p>
  </footer>
  </article>
        </main>
        <footer>
                <address>
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>,
                which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address>
        </footer>
</body>
</html>